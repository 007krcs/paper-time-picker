<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">
<link rel="import" href="../iron-resizable/iron-resizable-behavior.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="paper-clock-selector.html">

<!--

[Material Design Pickers](http://www.google.com/design/spec/components/pickers.html)

Provides a responsive time picker based on the material design spec. This
component aims to be a clone of the time picker introduced in Android Lollipop.

## Examples:

Default picker:

    <paper-time-picker></paper-time-picker>

Setting the initial time to 4:20pm (note that hours given as 24-hour):

    <paper-time-picker hour="16" minute="20"></paper-time-picker>

If you include this element as part of `paper-dialog`, use the class
`"paper-time-picker-dialog"` on the dialog in order to give it proper styling.

    <paper-dialog id="dialog" modal class="paper-time-picker-dialog">
      <paper-time-picker id="timePicker"></paper-time-picker>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm>OK</paper-button>
      </div>
    </paper-dialog>

@element paper-time-picker
@blurb Provides a responsive time picker based on the material design spec.
@homepage http://bendavis78.github.io/paper-time-picker/
@demo demo/index.html

-->

<style is="custom-style">
  /* Allow easy styling of a paper-dialog containing paper-time-picker */
  :root {
    --paper-time-picker-dialog-picker: {
      margin-top: 0;
      margin-bottom: 0;
      padding: 0;
    };
    --paper-time-picker-dialog: {
      margin: 0;
      max-height: 520px !important;
    };
  }
  :root .paper-time-picker-dialog {
    @apply(--paper-time-picker-dialog);
  }
  :root .paper-time-picker-dialog > paper-time-picker {
    @apply(--paper-time-picker-dialog-picker);
  }
</style>

<dom-module id="paper-time-picker">
  <template>
    <style>
      :host /deep/ * {
        --webkit-tap-highlight-color: rgba(0,0,0,0);
      }
      :host {
        display: block;
        background-color: var(--primary-background-color);
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        overflow: hidden;
        @apply(--paper-font-body1);
        font-size: 14px;
      }

      #timePicker {
        height: 100%;
        @apply(--layout-horizontal);
      }
      :host([narrow]) #timePicker {
        @apply(--layout-vertical);
      }

      /** Horizontal ******************/
      :host {
        width: 520px;
        height: 240px;
      }
      #heading {
        width: 270px;
        height: 240px;
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-center-justified);
      }
      #clockArea {
        margin: 12px 22px;
        @apply(--layout-vertical);
        @apply(--layout-flex);
      }

      /** Narrow *********************/
      :host([narrow]) {
        width: 270px;
        height: 366px;
      }
      :host([narrow]) #heading {
        height: 96px;
      }
      :host([narrow]) #clock {
        margin: 10px 18px;
      }

      /** Heading ********************/
      #heading {
        color: var(--light-primary-color);
        background: var(--default-primary-color);
      }
      #heading .time {
        font-size: 0;
        width: 200px;
        text-align: right;
      }
      #heading .time .iron-selected {
        color: var(--text-primary-color);
      }
      #heading .time .period {
        @apply(--paper-font-title);
        padding-left: 4px;
        line-height: 33px !important;
      }
      #heading .time div {
        @apply(--paper-font-display3);
        display: inline-block;
        padding: 2px;
      }
      #heading .time div:hover {
        cursor: pointer;
      }

      /** Clock *********************/
      #clockArea {
        position: relative;
      }
      #selectors {
        pointer-events: none;
      }
      #selectors,
      #selectors > section,
      #selectors > section > * {
        @apply(--layout-fit);
      }

      #selectors section.iron-selected {
        z-index: 1000;
      }
      #selectors section {
        z-index: 0;
      }

      /** Period selector *************/
      #periodSelector {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 38px;
        @apply(--layout-horizontal);
        @apply(--layout-justified);
      }
      #periodSelector .period {
        cursor: pointer;
        width: 36px;
        height: 36px;
        line-height: 38px;
        border-radius: 100%;
        text-align: center;
        vertical-align: middle;
      }
      #periodSelector .period.iron-selected {
        background: var(--default-primary-color);
        color: var(--text-primary-color);
      }

      /** Clock transition ***********/
      #selectors .iron-selected /deep/ #clock .face {
        opacity: 1;
      }
      #selectors .iron-selected /deep/ #clock #numbers {
        transform: scale(1);
        opacity: 1;
      }
      #selectors /deep/ #clock .face {
        transition: opacity 500ms;
        opacity: 0;
      }
      #selectors /deep/ #clock #numbers {
        transition: transform 500ms, opacity 500ms;
        transform: scale(1.2);
        transform-origin: 50% 50%;
        opacity: 0;
      }
    </style>
    <iron-media-query query="{{_getMediaQuery(forceNarrow, responsiveWidth)}}" query-matches="{{_queryMatches}}"></iron-media-query>
    <div id="timePicker">
      <div id="heading">
        <iron-selector class="time" id="timeParts" selectable="[name]" attr-for-selected="name" selected="{{view}}">
          <div name="hours" class="hour">{{hour12}}</div>
          <div class="sep">:</div>
          <div name="minutes" class="minute">{{_zeroPad(minute, 2)}}</div>
          <div class="period" self-end on-tap="togglePeriod">{{period}}</div>
        </iron-selector>
      </div>
      <div id="clockArea">
        <iron-selector id="periodSelector" selected="{{period}}" attr-for-selected="name">
          <div class="period" name="AM">AM</div>
          <div class="period" name="PM">PM</div>
        </iron-selector>
        <iron-selector id="selectors" selected="{{view}}" attr-for-selected="name" activate-event="">
          <section name="hours" id$="selectHour">
            <paper-clock-selector id="hourSelector" count="12" selected="{{hour12}}"></paper-clock-selector> 
          </section>
          <section name="minutes" id$="selectMinute">
            <paper-clock-selector id="minuteSelector" count="60" selected="{{minute}}" zero-pad use-zero></paper-clock-selector>
          </section>
        </iron-selector>
      </div>
    </div>
  </template>
  <script>
    (function() {
      var noop = function() {};
      var console = window.console || {warn: noop, log: noop, error: noop};

      Polymer({
        is: 'paper-time-picker',
        properties: {
          /**
           * Maximum screen width at which the picker uses a vertical layout
           * @attribute responsiveWidth
           * @type string
           * @default '640px'
           */
          responsiveWidth: {
            type: String,
            value: '640px'
          },
          /**
           * Force narrow layout
           */
          forceNarrow: {
            type: Boolean,
            value: false
          },
          narrow: {
            type: Boolean,
            reflectToAttribute: true,
            value: false,
            notify: true,
          },
          isTouch: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          /**
           * The current time as a formatted string
           */
          time: {
            type: String,
            notify: true,
            value: '12:00 AM',
            observer: '_timeChanged'
          },
          /**
           * The time value as the number of minutes from midnight
           */
          rawValue: {
            type: Number,
            notify: true,
            value: 0,
            observer: '_rawValueChanged'
          },
          /**
           * The current 24-hour value (0-24)
           */
          hour: {
            type: Number,
            notify: true,
            observer: '_hourChanged',
            value: 0
          },
          /**
           * The current 12-hour value (0-12)
           */
          hour12: {
            type: Number,
            notify: true,
            observer: '_hour12Changed'
          },
          /**
           * The current minute (0-59)
           */
          minute: {
            type: Number,
            notify: true,
            observer: '_minuteChanged',
            value: 0
          },
          /**
           * The current period ('AM', 'PM')
           */
          period: {
            type: String,
            notify: true,
            observer: '_periodChanged',
            value: 'AM'
          },
          /**
           * The current selector view ('hours', 'minutes')
           */
          view: {
            type: String,
            notify: true,
            value: 'hours',
            observer: '_viewChanged'
          },
          _queryMatches: {
            type: Boolean,
            value: false,
            observer: '_computeNarrow'
          }
        },
        behaviors: [
          Polymer.IronResizableBehavior
        ],
        observers: [
          '_updateRawValue(hour, minute)',
          '_updateTime(hour, minute)'
        ],
        ready: function() {
          this.isTouch = 'ontouchstart' in window;
          this.view = 'hours';
          this.addEventListener('paper-clock-selected', this._timeSelected);
        },
        /**
         * @param {number} hour The hour from 0-23
         * @param {number} minute The minute from 0-60
         * @returns {string} The formatted string
         */
        formatTime: function(hour, minute) {
          var period = (hour % 24) < 12 ? 'AM' : 'PM';
          hour = hour % 12 || 12;
          minute = ('0' + minute).substr(-2);
          return hour + ':' + minute + ' ' + period;
        },
        /**
         * @param {string} timeString
         * @param {boolean} raw Return raw value (minutes since midnight) instead of object
         * @returns {Object} An object in the form of {hour: [0-23], minute: [0-59]}
         */
        parseTime: function(timeString, raw) {
          var pattern = /^\s*(\d{1,2}):?(\d{2})(\s*([AaPp])\.?[Mm]\.?|[A-Z])?\s*$/;
          var match = timeString.match(pattern);
          if (!match) {
            console.warn('Invalid time:', timeString);
            return;
          }
          var hour = parseInt(match[1]);
          var minute = parseInt(match[2]);
          var period = match[4] ? (match[4][0].toUpperCase() + 'M') : 'AM';
          if (period === 'PM' && hour < 12) {
            hour = (hour + 12) % 24;
          } else if (period === 'AM' && hour === 12) {
            hour = 0;
          }
          if (raw) {
            return (hour * 60) + minute;
          }
          return {hour: hour, minute: minute};
        },
        /**
         * Toggle between AM/PM
         */
        togglePeriod: function() {
          this.period = (this.period === 'AM') ? 'PM' : 'AM';
        },
        _resetValue: function(prop, oldValue) {
          if (typeof oldValue !== 'undefined') {
            this[prop] = oldValue;
          }
        },
        _timeChanged: function(timeString, oldValue) {
          var time = this.parseTime(timeString);
          if (!time) {
            this._resetValue('time', oldValue);
            return;
          }
          this.hour = time.hour;
          this.minute = time.minute;
        },
        _updateTime: function(hour, minute) {
          this.time = this.formatTime(hour, minute);
        },
        _rawValueChanged: function(value, oldValue) {
          value = parseInt(value);
          if (isNaN(value)) {
            this._resetValue('rawValue', oldValue);
            return;
          }
          this.hour = Math.floor(value / 60) % 24;
          this.minute = value % 60;
        },
        _updateRawValue: function(hour, minute) {
          this.rawValue = (hour * 60) + minute;
        },
        _hour12Changed: function(hour12, oldValue) {
          hour12 = parseInt(hour12);
          if (isNaN(hour12)) {
            this._resetValue('hour12', oldValue);
            return;
          }
          var add = (this.period === 'PM' ? 12 : 0);
          this.hour = ((hour12 % 12) + add) % 24;
        },
        _hourChanged: function(hour, oldValue) {
          hour = parseInt(hour) % 24;
          if (isNaN(hour)) {
            console.warn('Invalid number:', arguments[0]);
            this._resetValue('hour', oldValue);
            return;
          }
          this.hour = hour;
          this.hour12 = this._twelveHour(hour);
          this.period = ['PM', 'AM'][+(hour < 12)];
        },
        _minuteChanged: function(minute, oldValue) {
          minute = parseInt(minute) % 60;
          if (isNaN(minute)) {
            console.warn('Invalid number:', arguments[0]);
            this._resetValue('minute', oldValue);
            return;
          }
          this.minute = minute;
        },
        _periodChanged: function(period, oldValue) {
          period = period ? period.toString().toUpperCase()[0] + 'M' : '';
          if (period !== 'AM' && period !== 'PM') {
            console.warn('invalid period: ', arguments[0]);
            this._resetValue('period', oldValue);
            return;
          }
          if (period === 'AM' &&  this.hour >= 12) {
            this.hour -= 12;
          } else if (period === 'PM' && this.hour < 12) {
            this.hour += 12;
          }
        },
        _viewChanged: function(view) {
          if (view !== 'hours' && view !== 'minutes') {
            this.view = 'hours';
          }
        },
        _zeroPad: function(value, length) {
          if (value === undefined || isNaN(value) || isNaN(length)) {
            return;
          }
          return ('0' + value).substr(-length);
        },
        _twelveHour: function(hour) {
          return hour % 12 || 12;
        },
        _isEqual: function(a, b) {
          return a === b;
        },
        _getMediaQuery: function(forceNarrow, responsiveWidth) {
          return '(max-width: ' + (forceNarrow ? '' : responsiveWidth) + ')';
        },
        _computeNarrow: function() {
          this.set('narrow', this._queryMatches || this.forceNarrow);
        },
        _timeSelected: function(e) {
          if (this.view === 'hours') {
            this.hour12 = e.detail.value;
          } else {
            this.minute = e.detail.value;
          }
          this.view = 'minutes';
        }
      });
    })();
  </script>
</dom-module>
